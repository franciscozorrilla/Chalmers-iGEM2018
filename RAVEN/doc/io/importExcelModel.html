<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importExcelModel</title>
  <meta name="keywords" content="importExcelModel">
  <meta name="description" content="importExcelModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; importExcelModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importExcelModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importExcelModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importExcelModel
   Imports a constraint-based model from a Excel file

   fileName      a Microsoft Excel file to import
   removeExcMets true if exchange metabolites should be removed. This is
                 needed to be able to run simulations, but it could also
                 be done using simplifyModel at a later stage (opt,
                 default true)
   printWarnings true if warnings should be printed (opt, default true)
   ignoreErrors  true if errors should be ignored. See below for details
                 (opt, default false)

   model
       description      description of model contents
       id               model ID
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       rxnNotes         reaction notes
       rxnReferences    reaction references
       rxnConfidenceScores reaction confidence scores
       genes            list of all genes
       geneComps        compartments for genes
       geneMiriams      structure with MIRIAM information about the genes
       geneShortNames   gene alternative names (e.g. ERG10)
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       metCharges       metabolite charge
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the RAVEN Toolbox Excel format. A number of consistency
   checks are performed in order to ensure that the model is valid. These
   can be ignored by putting ignoreErrors to true. However, this is highly
   advised against, as it can result in errors in simulations or other
   functionalities. The RAVEN Toolbox is made to function only on consistent
   models, and the only checks performed are when the model is imported.

   NOTE: Most errors are checked for by checkModelStruct, but some
   are checked for in this function as well. Those are ones which relate
   to missing model elements and so on, and which would make it impossible
   to construct the model structure. Those errors cannot be ignored by
   setting ignoreErrors to true.

   Usage: model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)

   Eduard Kerkhoven, 2018-05-18</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>	cleanSheet</li><li><a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>	loadSheet</li><li><a href="loadWorkbook.html" class="code" title="function workbook=loadWorkbook(fileName,createEmpty)">loadWorkbook</a>	loadWorkbook</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="SBMLFromExcel.html" class="code" title="function SBMLFromExcel(fileName, outputFileName,toCOBRA,printWarnings)">SBMLFromExcel</a>	SBMLFromExcel</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function miriamStruct=parseMiriam(strings,miriamStruct)</a></li><li><a href="#_sub2" class="code">function y=toStr(x)</a></li><li><a href="#_sub3" class="code">function y=toDouble(x,default)</a></li><li><a href="#_sub4" class="code">function y=boolToDouble(x)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)</a>
0002 <span class="comment">% importExcelModel</span>
0003 <span class="comment">%   Imports a constraint-based model from a Excel file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   fileName      a Microsoft Excel file to import</span>
0006 <span class="comment">%   removeExcMets true if exchange metabolites should be removed. This is</span>
0007 <span class="comment">%                 needed to be able to run simulations, but it could also</span>
0008 <span class="comment">%                 be done using simplifyModel at a later stage (opt,</span>
0009 <span class="comment">%                 default true)</span>
0010 <span class="comment">%   printWarnings true if warnings should be printed (opt, default true)</span>
0011 <span class="comment">%   ignoreErrors  true if errors should be ignored. See below for details</span>
0012 <span class="comment">%                 (opt, default false)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%   model</span>
0015 <span class="comment">%       description      description of model contents</span>
0016 <span class="comment">%       id               model ID</span>
0017 <span class="comment">%       rxns             reaction ids</span>
0018 <span class="comment">%       mets             metabolite ids</span>
0019 <span class="comment">%       S                stoichiometric matrix</span>
0020 <span class="comment">%       lb               lower bounds</span>
0021 <span class="comment">%       ub               upper bounds</span>
0022 <span class="comment">%       rev              reversibility vector</span>
0023 <span class="comment">%       c                objective coefficients</span>
0024 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0025 <span class="comment">%       comps            compartment ids</span>
0026 <span class="comment">%       compNames        compartment names</span>
0027 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0028 <span class="comment">%                        surrounding each of the compartments</span>
0029 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0030 <span class="comment">%                        compartments</span>
0031 <span class="comment">%       rxnNames         reaction description</span>
0032 <span class="comment">%       rxnComps         compartments for reactions</span>
0033 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0034 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0035 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0036 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0037 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0038 <span class="comment">%       rxnNotes         reaction notes</span>
0039 <span class="comment">%       rxnReferences    reaction references</span>
0040 <span class="comment">%       rxnConfidenceScores reaction confidence scores</span>
0041 <span class="comment">%       genes            list of all genes</span>
0042 <span class="comment">%       geneComps        compartments for genes</span>
0043 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0044 <span class="comment">%       geneShortNames   gene alternative names (e.g. ERG10)</span>
0045 <span class="comment">%       metNames         metabolite description</span>
0046 <span class="comment">%       metComps         compartments for metabolites</span>
0047 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0048 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0049 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0050 <span class="comment">%       metCharges       metabolite charge</span>
0051 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%   Loads models in the RAVEN Toolbox Excel format. A number of consistency</span>
0054 <span class="comment">%   checks are performed in order to ensure that the model is valid. These</span>
0055 <span class="comment">%   can be ignored by putting ignoreErrors to true. However, this is highly</span>
0056 <span class="comment">%   advised against, as it can result in errors in simulations or other</span>
0057 <span class="comment">%   functionalities. The RAVEN Toolbox is made to function only on consistent</span>
0058 <span class="comment">%   models, and the only checks performed are when the model is imported.</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%   NOTE: Most errors are checked for by checkModelStruct, but some</span>
0061 <span class="comment">%   are checked for in this function as well. Those are ones which relate</span>
0062 <span class="comment">%   to missing model elements and so on, and which would make it impossible</span>
0063 <span class="comment">%   to construct the model structure. Those errors cannot be ignored by</span>
0064 <span class="comment">%   setting ignoreErrors to true.</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%   Usage: model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%   Eduard Kerkhoven, 2018-05-18</span>
0069 <span class="comment">%</span>
0070 
0071 <span class="keyword">if</span> nargin&lt;2
0072     removeExcMets=true;
0073 <span class="keyword">end</span>
0074 <span class="keyword">if</span> nargin&lt;3
0075     printWarnings=true;
0076 <span class="keyword">end</span>
0077 <span class="keyword">if</span> nargin&lt;4
0078     ignoreErrors=false;
0079 <span class="keyword">end</span>
0080 
0081 <span class="keyword">if</span> ~(exist(fileName,<span class="string">'file'</span>)==2)
0082     error(<span class="string">'Excel file %s cannot be found'</span>,string(fileName));
0083 <span class="keyword">end</span>
0084 
0085 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0086 <span class="comment">%from SBML</span>
0087 model=[];
0088 model.id=[];
0089 model.description=[];
0090 model.annotation=[];
0091 <span class="comment">%Default bounds if not defined</span>
0092 model.annotation.defaultLB=-1000;
0093 model.annotation.defaultUB=1000;
0094 model.rxns={};
0095 model.mets={};
0096 model.S=[];
0097 model.lb=[];
0098 model.ub=[];
0099 model.rev=[];
0100 model.c=[];
0101 model.b=[];
0102 model.comps={};
0103 model.compNames={};
0104 model.compOutside={};
0105 model.compMiriams={};
0106 model.rxnNames={};
0107 model.rxnComps={}; <span class="comment">%Will be double later</span>
0108 model.grRules={};
0109 model.rxnGeneMat=[];
0110 model.subSystems={};
0111 model.eccodes={};
0112 model.rxnMiriams={};
0113 model.rxnNotes={};
0114 model.rxnReferences={};
0115 model.rxnConfidenceScores={}; <span class="comment">%Will be double later</span>
0116 model.genes={};
0117 model.geneComps={}; <span class="comment">%Will be double later</span>
0118 model.geneMiriams={};
0119 model.geneShortNames={};
0120 model.metNames={};
0121 model.metComps=[];
0122 model.inchis={};
0123 model.metFormulas={};
0124 model.metMiriams={};
0125 model.metCharges={}; <span class="comment">%Will be double later</span>
0126 model.unconstrained=[];
0127 
0128 workbook=<a href="loadWorkbook.html" class="code" title="function workbook=loadWorkbook(fileName,createEmpty)">loadWorkbook</a>(fileName);
0129 
0130 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'MODEL'</span>);
0131 
0132 <span class="keyword">if</span> flag&lt;0
0133     <span class="keyword">if</span> printWarnings==true
0134         EM=<span class="string">'Could not load the MODEL sheet'</span>;
0135         dispEM(EM,false);
0136     <span class="keyword">end</span>
0137     model.id=<span class="string">'UNKNOWN'</span>;
0138     model.description=<span class="string">'No model details available'</span>;
0139 <span class="keyword">else</span>
0140     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0141     
0142     <span class="comment">%It is assumed that the first line is labels and that the second one is</span>
0143     <span class="comment">%info</span>
0144     allLabels={<span class="string">'ID'</span>;<span class="string">'DESCRIPTION'</span>;<span class="string">'DEFAULT LOWER'</span>;<span class="string">'DEFAULT UPPER'</span>;<span class="string">'CONTACT GIVEN NAME'</span>;<span class="string">'CONTACT FAMILY NAME'</span>;<span class="string">'CONTACT EMAIL'</span>;<span class="string">'ORGANIZATION'</span>;<span class="string">'TAXONOMY'</span>;<span class="string">'NOTES'</span>};
0145     
0146     <span class="comment">%Map to new captions</span>
0147     raw(1,:)=upper(raw(1,:));
0148     raw(1,:)=strrep(raw(1,:),<span class="string">'MODELID'</span>,<span class="string">'ID'</span>);
0149     raw(1,:)=strrep(raw(1,:),<span class="string">'MODELNAME'</span>,<span class="string">'DESCRIPTION'</span>);
0150     
0151     <span class="comment">%Loop through the labels</span>
0152     [I, J]=ismember(raw(1,:),allLabels);
0153     I=find(I);
0154     <span class="keyword">for</span> i=1:numel(I)
0155         <span class="keyword">switch</span> J(I(i))
0156             <span class="keyword">case</span> 1
0157                 <span class="keyword">if</span> any(raw{I(i),2})
0158                     model.id=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0159                 <span class="keyword">else</span>
0160                     EM=<span class="string">'No model ID supplied'</span>;
0161                     dispEM(EM);
0162                 <span class="keyword">end</span>
0163             <span class="keyword">case</span> 2
0164                 <span class="keyword">if</span> any(raw{2,I(i)})
0165                     model.description=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0166                 <span class="keyword">else</span>
0167                     EM=<span class="string">'No model name supplied'</span>;
0168                     dispEM(EM);
0169                 <span class="keyword">end</span>
0170             <span class="keyword">case</span> 3
0171                 <span class="keyword">if</span> ~isempty(raw{2,I(i)})
0172                     <span class="keyword">try</span>
0173                         model.annotation.defaultLB=<a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(raw{2,I(i)},NaN);
0174                     <span class="keyword">catch</span>
0175                         EM=<span class="string">'DEFAULT LOWER must be numeric'</span>;
0176                         dispEM(EM);
0177                     <span class="keyword">end</span>
0178                 <span class="keyword">else</span>
0179                     <span class="keyword">if</span> printWarnings==true
0180                         fprintf(<span class="string">'NOTE: DEFAULT LOWER not supplied. Uses -1000\n'</span>);
0181                     <span class="keyword">end</span>
0182                     model.annotation.defaultLB=-1000;
0183                 <span class="keyword">end</span>
0184             <span class="keyword">case</span> 4
0185                 <span class="keyword">if</span> ~isempty(raw{2,I(i)})
0186                     <span class="keyword">try</span>
0187                         model.annotation.defaultUB=<a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(raw{2,I(i)},NaN);
0188                     <span class="keyword">catch</span>
0189                         EM=<span class="string">'DEFAULT UPPER must be numeric'</span>;
0190                         dispEM(EM);
0191                     <span class="keyword">end</span>
0192                 <span class="keyword">else</span>
0193                     <span class="keyword">if</span> printWarnings==true
0194                         fprintf(<span class="string">'NOTE: DEFAULT UPPER not supplied. Uses 1000\n'</span>);
0195                     <span class="keyword">end</span>
0196                     model.annotation.defaultUB=1000;
0197                 <span class="keyword">end</span>
0198             <span class="keyword">case</span> 5
0199                 <span class="keyword">if</span> any(raw{2,I(i)})
0200                     model.annotation.givenName=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0201                 <span class="keyword">end</span>
0202             <span class="keyword">case</span> 6
0203                 <span class="keyword">if</span> any(raw{2,I(i)})
0204                     model.annotation.familyName=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0205                 <span class="keyword">end</span>
0206             <span class="keyword">case</span> 7
0207                 <span class="keyword">if</span> any(raw{2,I(i)})
0208                     model.annotation.email=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0209                 <span class="keyword">end</span>
0210             <span class="keyword">case</span> 8
0211                 <span class="keyword">if</span> any(raw{2,I(i)})
0212                     model.annotation.organization=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0213                 <span class="keyword">end</span>
0214             <span class="keyword">case</span> 9
0215                 <span class="keyword">if</span> any(raw{2,I(i)})
0216                     model.annotation.taxonomy=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0217                 <span class="keyword">end</span>
0218             <span class="keyword">case</span> 10
0219                 <span class="keyword">if</span> any(raw{2,I(i)})
0220                     model.annotation.note=<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>(raw{2,I(i)}); <span class="comment">%Should be string already</span>
0221                 <span class="keyword">end</span>
0222         <span class="keyword">end</span>
0223     <span class="keyword">end</span>
0224 <span class="keyword">end</span>
0225 
0226 <span class="comment">%Get compartment information</span>
0227 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'COMPS'</span>);
0228 
0229 <span class="keyword">if</span> flag&lt;0
0230     <span class="keyword">if</span> printWarnings==true
0231         EM=<span class="string">'Could not load the COMPS sheet. All elements will be assigned to a compartment &quot;s&quot; for &quot;System&quot;'</span>;
0232         dispEM(EM,false);
0233     <span class="keyword">end</span>
0234     model.comps={<span class="string">'s'</span>};
0235     model.compNames={<span class="string">'System'</span>};
0236 <span class="keyword">else</span>
0237     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0238     
0239     <span class="comment">%Map to new captions</span>
0240     raw(1,:)=upper(raw(1,:));
0241     raw(1,:)=strrep(raw(1,:),<span class="string">'COMPABBREV'</span>,<span class="string">'ABBREVIATION'</span>);
0242     raw(1,:)=strrep(raw(1,:),<span class="string">'COMPNAME'</span>,<span class="string">'NAME'</span>);
0243     
0244     allLabels={<span class="string">'ABBREVIATION'</span>;<span class="string">'NAME'</span>;<span class="string">'INSIDE'</span>;<span class="string">'MIRIAM'</span>};
0245     
0246     <span class="comment">%Loop through the labels</span>
0247     [I, J]=ismember(raw(1,:),allLabels);
0248     I=find(I);
0249     <span class="keyword">for</span> i=1:numel(I)
0250         <span class="keyword">switch</span> J(I(i))
0251             <span class="keyword">case</span> 1
0252                 model.comps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0253             <span class="keyword">case</span> 2
0254                 model.compNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0255             <span class="keyword">case</span> 3
0256                 model.compOutside=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0257             <span class="keyword">case</span> 4
0258                 model.compMiriams=raw(2:<span class="keyword">end</span>,I(i));
0259         <span class="keyword">end</span>
0260     <span class="keyword">end</span>
0261     
0262     <span class="comment">%Check that necessary fields are loaded</span>
0263     <span class="keyword">if</span> isempty(model.comps)
0264         EM=<span class="string">'There must be a column named ABBREVIATION in the COMPS sheet'</span>;
0265         dispEM(EM);
0266     <span class="keyword">end</span>
0267     <span class="keyword">if</span> isempty(model.compNames)
0268         model.compNames=model.comps;
0269         <span class="keyword">if</span> printWarnings==true
0270             EM=<span class="string">'There is no column named NAME in the COMPS sheet. ABBREVIATION will be used as name'</span>;
0271             dispEM(EM,false);
0272         <span class="keyword">end</span>
0273     <span class="keyword">end</span>
0274     
0275     model.compMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.compMiriams);
0276 <span class="keyword">end</span>
0277 
0278 <span class="comment">%Get all the genes and info about them</span>
0279 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'GENES'</span>);
0280 
0281 <span class="keyword">if</span> flag&lt;0
0282     <span class="keyword">if</span> printWarnings==true
0283         EM=<span class="string">'There is no spreadsheet named GENES'</span>;
0284         dispEM(EM,false)
0285     <span class="keyword">end</span>
0286 <span class="keyword">else</span>
0287     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0288     
0289     <span class="comment">%Map to new captions</span>
0290     raw(1,:)=upper(raw(1,:));
0291     raw(1,:)=strrep(raw(1,:),<span class="string">'GENE NAME'</span>,<span class="string">'NAME'</span>);
0292     
0293     allLabels={<span class="string">'NAME'</span>;<span class="string">'MIRIAM'</span>;<span class="string">'SHORT NAME'</span>;<span class="string">'COMPARTMENT'</span>};
0294     
0295     <span class="comment">%Loop through the labels</span>
0296     [I, J]=ismember(upper(raw(1,:)),allLabels);
0297     I=find(I);
0298     foundGenes=false;
0299     <span class="keyword">for</span> i=1:numel(I)
0300         <span class="keyword">switch</span> J(I(i))
0301             <span class="keyword">case</span> 1
0302                 model.genes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0303                 foundGenes=true;
0304             <span class="keyword">case</span> 2
0305                 model.geneMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0306             <span class="keyword">case</span> 3
0307                 model.geneShortNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0308             <span class="keyword">case</span> 4
0309                 model.geneComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0310         <span class="keyword">end</span>
0311     <span class="keyword">end</span>
0312     
0313     <span class="keyword">if</span> foundGenes==false
0314         EM=<span class="string">'There must be a column named NAME in the GENES sheet'</span>;
0315         dispEM(EM);
0316     <span class="keyword">end</span>
0317     
0318     <span class="comment">%Its ok if all of them are empty</span>
0319     <span class="keyword">if</span> all(cellfun(@isempty,model.geneComps))
0320         model.geneComps=[];
0321     <span class="keyword">end</span>
0322     
0323     <span class="comment">%Check that geneName contain only strings and no empty strings</span>
0324     <span class="keyword">if</span> ~iscellstr(model.genes)
0325         EM=<span class="string">'All gene names have to be strings'</span>;
0326         dispEM(EM);
0327     <span class="keyword">else</span>
0328         <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.genes))
0329             EM=<span class="string">'There can be no empty strings in gene names'</span>;
0330             dispEM(EM);
0331         <span class="keyword">end</span>
0332     <span class="keyword">end</span>
0333     
0334     <span class="comment">%Check that geneComp contains only strings and no empty string</span>
0335     <span class="keyword">if</span> ~isempty(model.geneComps)
0336         <span class="keyword">if</span> ~iscellstr(model.geneComps)
0337             EM=<span class="string">'All gene compartments have to be strings'</span>;
0338             dispEM(EM);
0339         <span class="keyword">else</span>
0340             <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.geneComps))
0341                 EM=<span class="string">'There can be no empty strings in gene compartments'</span>;
0342                 dispEM(EM);
0343             <span class="keyword">end</span>
0344         <span class="keyword">end</span>
0345         [I, model.geneComps]=ismember(model.geneComps,model.comps);
0346         EM=<span class="string">'The following genes have compartment abbreviations which could not be found:'</span>;
0347         dispEM(EM,true,model.genes(~I));
0348     <span class="keyword">end</span>
0349 <span class="keyword">end</span>
0350 
0351 model.geneMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.geneMiriams);
0352 
0353 <span class="comment">%Loads the reaction data</span>
0354 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'RXNS'</span>);
0355 
0356 <span class="keyword">if</span> flag&lt;0
0357     EM=<span class="string">'Could not load the RXNS sheet'</span>;
0358     dispEM(EM);
0359 <span class="keyword">end</span>
0360 
0361 raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0362 
0363 <span class="comment">%Map to new captions</span>
0364 raw(1,:)=upper(raw(1,:));
0365 raw(1,:)=strrep(raw(1,:),<span class="string">'RXNID'</span>,<span class="string">'ID'</span>);
0366 
0367 allLabels={<span class="string">'ID'</span>;<span class="string">'NAME'</span>;<span class="string">'EQUATION'</span>;<span class="string">'EC-NUMBER'</span>;<span class="string">'GENE ASSOCIATION'</span>;<span class="string">'LOWER BOUND'</span>;<span class="string">'UPPER BOUND'</span>;<span class="string">'OBJECTIVE'</span>;<span class="string">'COMPARTMENT'</span>;<span class="string">'SUBSYSTEM'</span>;<span class="string">'REPLACEMENT ID'</span>;<span class="string">'MIRIAM'</span>;<span class="string">'NOTE'</span>;<span class="string">'REFERENCE'</span>;<span class="string">'CONFIDENCE SCORE'</span>};
0368 equations={};
0369 reactionReplacement={};
0370 
0371 <span class="comment">%Loop through the labels</span>
0372 [I, J]=ismember(raw(1,:),allLabels);
0373 I=find(I);
0374 <span class="keyword">for</span> i=1:numel(I)
0375     <span class="keyword">switch</span> J(I(i))
0376         <span class="keyword">case</span> 1
0377             model.rxns=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0378         <span class="keyword">case</span> 2
0379             model.rxnNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0380         <span class="keyword">case</span> 3
0381             equations=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0382         <span class="keyword">case</span> 4
0383             model.eccodes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0384         <span class="keyword">case</span> 5
0385             model.grRules=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0386         <span class="keyword">case</span> 6
0387             <span class="keyword">try</span>
0388                 model.lb=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,NaN),raw(2:<span class="keyword">end</span>,I(i)));
0389             <span class="keyword">catch</span>
0390                 EM=<span class="string">'The lower bounds must be numerical values'</span>;
0391                 dispEM(EM);
0392             <span class="keyword">end</span>
0393         <span class="keyword">case</span> 7
0394             <span class="keyword">try</span>
0395                 model.ub=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,NaN),raw(2:<span class="keyword">end</span>,I(i)));
0396             <span class="keyword">catch</span>
0397                 EM=<span class="string">'The upper bounds must be numerical values'</span>;
0398                 dispEM(EM);
0399             <span class="keyword">end</span>
0400         <span class="keyword">case</span> 8
0401             <span class="keyword">try</span>
0402                 model.c=cellfun(@(x) <a href="#_sub3" class="code" title="subfunction y=toDouble(x,default)">toDouble</a>(x,0),raw(2:<span class="keyword">end</span>,I(i)));
0403             <span class="keyword">catch</span>
0404                 EM=<span class="string">'The objective coefficients must be numerical values'</span>;
0405                 dispEM(EM);
0406             <span class="keyword">end</span>
0407         <span class="keyword">case</span> 9
0408             model.rxnComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0409         <span class="keyword">case</span> 10
0410             subsystems=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0411         <span class="keyword">case</span> 11
0412             reactionReplacement=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0413         <span class="keyword">case</span> 12
0414             model.rxnMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0415         <span class="keyword">case</span> 13
0416             model.rxnNotes=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0417         <span class="keyword">case</span> 14
0418             model.rxnReferences=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0419         <span class="keyword">case</span> 15
0420             model.rxnConfidenceScores=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0421     <span class="keyword">end</span>
0422 <span class="keyword">end</span>
0423 
0424 <span class="keyword">if</span> ~isempty(model.rxnConfidenceScores)
0425     model.rxnConfidenceScores=str2double(model.rxnConfidenceScores);
0426 <span class="keyword">end</span>
0427 <span class="keyword">for</span> i=1:numel(subsystems)
0428     model.subSystems{i,1}=cellstr(strsplit(subsystems{i,1},<span class="string">';'</span>));
0429 <span class="keyword">end</span>
0430 
0431 <span class="comment">%Check that all necessary reaction info has been loaded</span>
0432 <span class="keyword">if</span> isempty(equations)
0433     EM=<span class="string">'There must be a column named EQUATION in the RXNS sheet'</span>;
0434     dispEM(EM);
0435 <span class="keyword">end</span>
0436 <span class="keyword">if</span> isempty(model.rxns)
0437     <span class="keyword">if</span> printWarnings==true
0438         EM=<span class="string">'There is no column named ID in the RXNS sheet. The reactions will be named as &quot;r1&quot;, &quot;r2&quot;...'</span>;
0439         dispEM(EM,false);
0440     <span class="keyword">end</span>
0441     I=num2cell((1:numel(equations))');
0442     model.rxns=strcat(<span class="string">'r'</span>,cellfun(@num2str,I,<span class="string">'UniformOutput'</span>,false));
0443 <span class="keyword">end</span>
0444 
0445 <span class="comment">%Check if some other stuff is loaded and populate with default values</span>
0446 <span class="comment">%otherwise</span>
0447 <span class="keyword">if</span> isempty(model.rxnNames)
0448     model.rxnNames=cell(numel(model.rxns),1);
0449     model.rxnNames(:)={<span class="string">''</span>};
0450     <span class="keyword">if</span> printWarnings==true
0451         EM=<span class="string">'There is no column named NAME in the RXNS sheet. Empty strings will be used as reaction names'</span>;
0452         dispEM(EM,false);
0453     <span class="keyword">end</span>
0454 <span class="keyword">end</span>
0455 <span class="keyword">if</span> isempty(model.lb)
0456     <span class="comment">%This is not set here since the reversibility isn't known yet</span>
0457     model.lb=nan(numel(model.rxns),1);
0458     <span class="keyword">if</span> printWarnings==true
0459         EM=<span class="string">'There is no column named LOWER BOUND in the RXNS sheet. Default bounds will be used'</span>;
0460         dispEM(EM,false);
0461     <span class="keyword">end</span>
0462 <span class="keyword">end</span>
0463 <span class="keyword">if</span> isempty(model.ub)
0464     model.ub=nan(numel(model.rxns),1);
0465     <span class="keyword">if</span> printWarnings==true
0466         EM=<span class="string">'There is no column named UPPER BOUND in the RXNS sheet. Default bounds will be used'</span>;
0467         dispEM(EM,false);
0468     <span class="keyword">end</span>
0469 <span class="keyword">end</span>
0470 <span class="keyword">if</span> isempty(model.c)
0471     model.c=zeros(numel(model.rxns),1);
0472     <span class="keyword">if</span> printWarnings==true
0473         EM=<span class="string">'There is no column named OBJECTIVE in the RXNS sheet'</span>;
0474         dispEM(EM,false);
0475     <span class="keyword">end</span>
0476 <span class="keyword">end</span>
0477 
0478 <span class="comment">%Either all reactions must have a compartment string or none of them. Check</span>
0479 <span class="comment">%if it's only empty and if so return it to []</span>
0480 <span class="keyword">if</span> ~isempty(model.rxnComps)
0481     <span class="keyword">if</span> all(cellfun(@isempty,model.rxnComps))
0482         model.rxnComps=[];
0483     <span class="keyword">end</span>
0484 <span class="keyword">end</span>
0485 
0486 <span class="comment">%Construct the rxnMiriams structure</span>
0487 model.rxnMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.rxnMiriams);
0488 
0489 <span class="comment">%Replace the reaction IDs for those IDs that have a corresponding</span>
0490 <span class="comment">%replacement name.</span>
0491 I=cellfun(@any,reactionReplacement);
0492 model.rxns(I)=reactionReplacement(I);
0493 
0494 <span class="comment">%Check that there are no empty strings in reactionIDs or equations</span>
0495 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.rxns))
0496     EM=<span class="string">'There are empty reaction IDs'</span>;
0497     dispEM(EM);
0498 <span class="keyword">end</span>
0499 
0500 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,equations))
0501     EM=<span class="string">'There are empty equations'</span>;
0502     dispEM(EM);
0503 <span class="keyword">end</span>
0504 
0505 <span class="keyword">if</span> ~isempty(model.rxnComps)
0506     <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.rxnComps))
0507         EM=<span class="string">'Either all reactions must have an associated compartment string or none of them'</span>;
0508         dispEM(EM);
0509     <span class="keyword">end</span>
0510 <span class="keyword">end</span>
0511 
0512 <span class="keyword">if</span> ~isempty(model.grRules)
0513     tempRules=model.grRules;
0514     <span class="keyword">for</span> i=1:length(model.rxns)
0515         <span class="comment">%Check that all gene associations have a match in the gene list</span>
0516         <span class="keyword">if</span> ~isempty(model.grRules{i})
0517             tempRules{i}=regexprep(tempRules{i},<span class="string">' and | or '</span>,<span class="string">'&gt;'</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0518             tempRules{i}=regexprep(tempRules{i},<span class="string">'('</span>,<span class="string">''</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0519             tempRules{i}=regexprep(tempRules{i},<span class="string">')'</span>,<span class="string">''</span>); <span class="comment">%New format: Genes are separated 'and' and 'or' strings with parentheses</span>
0520             indexesNew=strfind(tempRules{i},<span class="string">'&gt;'</span>); <span class="comment">%Old format: Genes are separated by &quot;:&quot; for AND and &quot;;&quot; for OR</span>
0521             indexes=strfind(tempRules{i},<span class="string">':'</span>); <span class="comment">%Old format: Genes are separated by &quot;:&quot; for AND and &quot;;&quot; for OR</span>
0522             indexes=unique([indexesNew indexes strfind(tempRules{i},<span class="string">';'</span>)]);
0523             <span class="keyword">if</span> isempty(indexes)
0524                 <span class="comment">%See if you have a match</span>
0525                 I=find(strcmp(tempRules{i},model.genes));
0526                 <span class="keyword">if</span> isempty(I)
0527                     EM=[<span class="string">'The gene association in reaction '</span> model.rxns{i} <span class="string">' ('</span> tempRules{i} <span class="string">') is not present in the gene list'</span>];
0528                     dispEM(EM);
0529                 <span class="keyword">end</span>
0530             <span class="keyword">else</span>
0531                 temp=[0 indexes numel(tempRules{i})+1];
0532                 <span class="keyword">for</span> j=1:numel(indexes)+1
0533                     <span class="comment">%The reaction has several associated genes</span>
0534                     geneName=tempRules{i}(temp(j)+1:temp(j+1)-1);
0535                     I=find(strcmp(geneName,model.genes));
0536                     <span class="keyword">if</span> isempty(I)
0537                         EM=[<span class="string">'The gene association in reaction '</span> model.rxns{i} <span class="string">' ('</span> geneName <span class="string">') is not present in the gene list'</span>];
0538                         dispEM(EM);
0539                     <span class="keyword">end</span>
0540                 <span class="keyword">end</span>
0541             <span class="keyword">end</span>
0542             <span class="comment">%In order to adhere to the COBRA standards it should be like</span>
0543             <span class="comment">%this: -If only one gene then no parentheses -If only &quot;and&quot; or</span>
0544             <span class="comment">%only &quot;or&quot; there should only be one set of parentheses -If both</span>
0545             <span class="comment">%&quot;and&quot; and &quot;or&quot;, then split on &quot;or&quot;. This is not complete, but</span>
0546             <span class="comment">%it's the type of relationship supported by the Excel</span>
0547             <span class="comment">%formulation</span>
0548             aSign=strfind(model.grRules{i},<span class="string">':'</span>);
0549             oSign=strfind(model.grRules{i},<span class="string">';'</span>);
0550             <span class="keyword">if</span> isempty(aSign) &amp;&amp; isempty(oSign)
0551                 model.grRules{i}=model.grRules{i};
0552             <span class="keyword">else</span>
0553                 <span class="keyword">if</span> isempty(aSign)
0554                     model.grRules{i}=[<span class="string">'('</span> strrep(model.grRules{i},<span class="string">';'</span>,<span class="string">' or '</span>) <span class="string">')'</span>];
0555                 <span class="keyword">else</span>
0556                     <span class="keyword">if</span> isempty(oSign)
0557                         model.grRules{i}=[<span class="string">'('</span> strrep(model.grRules{i},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0558                     <span class="keyword">else</span>
0559                         model.grRules{i}=[<span class="string">'(('</span> strrep(model.grRules{i},<span class="string">';'</span>,<span class="string">') or ('</span>) <span class="string">'))'</span>];
0560                         model.grRules{i}=strrep(model.grRules{i},<span class="string">':'</span>,<span class="string">' and '</span>);
0561                     <span class="keyword">end</span>
0562                 <span class="keyword">end</span>
0563             <span class="keyword">end</span>
0564         <span class="keyword">end</span>
0565     <span class="keyword">end</span>
0566 <span class="keyword">end</span>
0567 
0568 <span class="comment">%Check that the compartment for each reaction can be found</span>
0569 <span class="keyword">if</span> ~isempty(model.rxnComps)
0570     [I, model.rxnComps]=ismember(model.rxnComps,model.comps);
0571     EM=<span class="string">'The following reactions have compartment abbreviations which could not be found:'</span>;
0572     dispEM(EM,true,model.rxns(~I));
0573 <span class="keyword">end</span>
0574 
0575 <span class="comment">%Get all the metabolites and info about them</span>
0576 [raw, flag]=<a href="loadSheet.html" class="code" title="function [raw, flag]=loadSheet(workbook, sheet)">loadSheet</a>(workbook,<span class="string">'METS'</span>);
0577 
0578 <span class="keyword">if</span> flag&lt;0
0579     <span class="keyword">if</span> printWarnings==true
0580         EM=<span class="string">'There is no spreadsheet named METS. The metabolites will be named &quot;m1&quot;, &quot;m2&quot;... and assigned to the first compartment'</span>;
0581         dispEM(EM,false);
0582     <span class="keyword">end</span>
0583     <span class="comment">%Parse the equations to find out how many metabolites there are</span>
0584     metsForParsing=parseRxnEqu(equations);
0585     I=num2cell((1:numel(metsForParsing))');
0586     model.mets=strcat(<span class="string">'m'</span>,cellfun(@num2str,I,<span class="string">'UniformOutput'</span>,false));
0587     model.metComps=ones(numel(model.mets),1);
0588     model.unconstrained=zeros(numel(model.mets),1);
0589     model.metNames=metsForParsing;
0590 <span class="keyword">else</span>
0591     raw=<a href="cleanSheet.html" class="code" title="function [raw,keptRows,keptCols]=cleanSheet(raw,removeComments,removeOnlyCap,removeNoCap,removeEmptyRows)">cleanSheet</a>(raw);
0592     
0593     <span class="comment">%Map to new captions</span>
0594     raw(1,:)=upper(raw(1,:));
0595     raw(1,:)=strrep(raw(1,:),<span class="string">'METID'</span>,<span class="string">'ID'</span>);
0596     raw(1,:)=strrep(raw(1,:),<span class="string">'METNAME'</span>,<span class="string">'NAME'</span>);
0597     
0598     allLabels={<span class="string">'ID'</span>;<span class="string">'NAME'</span>;<span class="string">'UNCONSTRAINED'</span>;<span class="string">'MIRIAM'</span>;<span class="string">'COMPOSITION'</span>;<span class="string">'INCHI'</span>;<span class="string">'COMPARTMENT'</span>;<span class="string">'REPLACEMENT ID'</span>;<span class="string">'CHARGE'</span>};
0599     
0600     <span class="comment">%Load the metabolite information</span>
0601     metReplacement={};
0602     
0603     <span class="comment">%Loop through the labels</span>
0604     [I, J]=ismember(raw(1,:),allLabels);
0605     I=find(I);
0606     <span class="keyword">for</span> i=1:numel(I)
0607         <span class="keyword">switch</span> J(I(i))
0608             <span class="keyword">case</span> 1
0609                 model.mets=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0610             <span class="keyword">case</span> 2
0611                 model.metNames=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0612             <span class="keyword">case</span> 3
0613                 model.unconstrained=cellfun(@<a href="#_sub4" class="code" title="subfunction y=boolToDouble(x)">boolToDouble</a>,raw(2:<span class="keyword">end</span>,I(i)));
0614                 
0615                 <span class="comment">%NaN is returned if the values couldn't be parsed</span>
0616                 EM=<span class="string">'The UNCONSTRAINED property for the following metabolites must be &quot;true&quot;/&quot;false&quot;, 1/0, TRUE/FALSE or not set:'</span>;
0617                 dispEM(EM,true,model.mets(isnan(model.unconstrained)));
0618             <span class="keyword">case</span> 4
0619                 model.metMiriams=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0620             <span class="keyword">case</span> 5
0621                 model.metFormulas=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0622             <span class="keyword">case</span> 6
0623                 model.inchis=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0624             <span class="keyword">case</span> 7
0625                 model.metComps=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0626                 
0627                 <span class="comment">%Check that all metabolites have compartments defined</span>
0628                 <span class="keyword">if</span> any(strcmp(<span class="string">''</span>,model.metComps))
0629                     EM=<span class="string">'All metabolites must have an associated compartment string'</span>;
0630                     dispEM(EM);
0631                 <span class="keyword">end</span>
0632             <span class="keyword">case</span> 8
0633                 metReplacement=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0634             <span class="keyword">case</span> 9
0635                 model.metCharges=cellfun(@<a href="#_sub2" class="code" title="subfunction y=toStr(x)">toStr</a>,raw(2:<span class="keyword">end</span>,I(i)),<span class="string">'UniformOutput'</span>,false);
0636         <span class="keyword">end</span>
0637     <span class="keyword">end</span>
0638     
0639     <span class="comment">%Check that necessary fields are loaded (METID)</span>
0640     <span class="keyword">if</span> isempty(model.mets)
0641         EM=<span class="string">'There must be a column named ID in the METS sheet'</span>;
0642         dispEM(EM);
0643     <span class="keyword">end</span>
0644     
0645     <span class="comment">%Check that some other stuff is loaded and use default values otherwise</span>
0646     <span class="keyword">if</span> isempty(model.metNames)
0647         model.metNames=cell(numel(model.mets),1);
0648         <span class="keyword">if</span> printWarnings==true
0649             EM=<span class="string">'There is no column named NAME in the METS sheet. ID will be used as name'</span>;
0650             dispEM(EM,false);
0651         <span class="keyword">end</span>
0652     <span class="keyword">end</span>
0653     <span class="keyword">if</span> isempty(model.unconstrained)
0654         model.unconstrained=zeros(numel(model.mets),1);
0655         <span class="keyword">if</span> printWarnings==true
0656             EM=<span class="string">'There is no column named UNCONSTRAINED in the METS sheet. All metabolites will be constrained'</span>;
0657             dispEM(EM,false);
0658         <span class="keyword">end</span>
0659     <span class="keyword">end</span>
0660     
0661     <span class="keyword">if</span> isempty(model.metComps)
0662         model.metComps=cell(numel(model.mets),1);
0663         model.metComps(:)=model.comps(1);
0664         <span class="keyword">if</span> printWarnings==true
0665             EM=<span class="string">'There is no column named COMPARTMENT in the METS sheet. All metabolites will be assigned to the first compartment in COMPS. Note that RAVEN makes extensive use of metabolite names and compartments. Some features will therefore not function correctly if metabolite compartments are not correctly assigned'</span>;
0666             dispEM(EM,false);
0667         <span class="keyword">end</span>
0668     <span class="keyword">end</span>
0669     
0670     <span class="comment">%The composition should be loaded from InChIs when available</span>
0671     I=find(~cellfun(@isempty,model.inchis));
0672     <span class="keyword">for</span> i=1:numel(I)
0673         S=regexp(model.inchis(I(i)),<span class="string">'/'</span>,<span class="string">'split'</span>);
0674         S=S{1};
0675         <span class="keyword">if</span> numel(S)&gt;=2
0676             <span class="comment">%Don't copy if it doesn't look good</span>
0677             model.metFormulas(I(i))=S(2);
0678         <span class="keyword">end</span>
0679     <span class="keyword">end</span>
0680     
0681     <span class="comment">%Check that the compartment for each metabolite can be found. Also</span>
0682     <span class="comment">%convert from id to index</span>
0683     [I, model.metComps]=ismember(model.metComps,model.comps);
0684     EM=<span class="string">'The following metabolites have compartment abbreviations which could not be found:'</span>;
0685     dispEM(EM,true,model.mets(~I));
0686     
0687     <span class="comment">%Check that the model.mets vector is unique. The problem is that the</span>
0688     <span class="comment">%checkModelStruct cannot check for that since only the metReplacements</span>
0689     <span class="comment">%(if used) end up in the model structure</span>
0690     I=false(numel(model.mets),1);
0691     [J, K]=unique(model.mets);
0692     <span class="keyword">if</span> numel(J)~=numel(model.mets)
0693         L=1:numel(model.mets);
0694         L(K)=[];
0695         I(L)=true;
0696     <span class="keyword">end</span>
0697     EM=<span class="string">'The following metabolites are duplicates:'</span>;
0698     dispEM(EM,~ignoreErrors,model.mets(I));
0699     
0700     <span class="comment">%Check that there are no metabolite IDs which are numbers. This would</span>
0701     <span class="comment">%give errors when parsing the equations</span>
0702     I=cellfun(@str2double,model.mets);
0703     EM=<span class="string">'The following metabolites have names which cannot be distinguished from numbers:'</span>;
0704     dispEM(EM,~ignoreErrors,model.mets(~isnan(I)));
0705     I=cellfun(@str2double,metReplacement);
0706     EM=<span class="string">'The following metabolites have names which cannot be distinguished from numbers:'</span>;
0707     dispEM(EM,~ignoreErrors,metReplacement(~isnan(I)));
0708     
0709     <span class="comment">%Replace the metabolite IDs for those IDs that have a corresponding</span>
0710     <span class="comment">%replacement metabolite. This is not used for matching, but will be</span>
0711     <span class="comment">%checked for consistency with SBML naming conventions</span>
0712     metsForParsing=model.mets; <span class="comment">%This is because the equations are written with this</span>
0713     I=cellfun(@any,metReplacement);
0714     model.mets(I)=metReplacement(I);
0715     
0716     <span class="comment">%If the metabolite name isn't set, replace it with the metabolite id</span>
0717     I=~cellfun(@any,model.metNames);
0718     model.metNames(I)=model.mets(I);
0719     
0720     <span class="comment">%Construct the metMiriams structure</span>
0721     model.metMiriams=<a href="#_sub1" class="code" title="subfunction miriamStruct=parseMiriam(strings,miriamStruct)">parseMiriam</a>(model.metMiriams);
0722     
0723     <span class="comment">%Either all metabolites have charge or none of them. Check if it's only</span>
0724     <span class="comment">%empty and if so return it to []</span>
0725     <span class="keyword">if</span> ~isempty(model.metCharges)
0726         <span class="keyword">if</span> all(cellfun(@isempty,model.metCharges))
0727             model.metCharges=[];
0728         <span class="keyword">end</span>
0729     <span class="keyword">end</span>
0730     <span class="keyword">if</span> ~isempty(model.metCharges)
0731         model.metCharges=str2double(model.metCharges);
0732     <span class="keyword">end</span>
0733 <span class="keyword">end</span>
0734 
0735 <span class="comment">%Everything seems fine with the metabolite IDs, compartments, genes, and</span>
0736 <span class="comment">%reactions</span>
0737 
0738 <span class="comment">%Parse the equations</span>
0739 [model.S, mets, badRxns, model.rev]=constructS(equations,metsForParsing,model.rxns);
0740 model.rev=model.rev*1; <span class="comment">%Typecast to double</span>
0741 
0742 <span class="comment">%Add default constraints</span>
0743 model.lb(isnan(model.lb))=model.annotation.defaultLB.*model.rev(isnan(model.lb));
0744 model.ub(isnan(model.ub))=model.annotation.defaultUB;
0745 
0746 <span class="comment">%Reorder the S matrix so that it fits with the metabolite list in the</span>
0747 <span class="comment">%structure</span>
0748 [~, I]=ismember(mets,metsForParsing);
0749 model.S=model.S(I,:);
0750 
0751 <span class="comment">%Print warnings about the reactions which contain the same metabolite as</span>
0752 <span class="comment">%both reactants and products</span>
0753 EM=<span class="string">'The following reactions have metabolites which are present more than once. Only the net reactions will be exported:'</span>;
0754 dispEM(EM,false,model.rxns(badRxns));
0755 
0756 model.b=zeros(numel(model.mets),1);
0757 
0758 <span class="comment">%Fix grRules and reconstruct rxnGeneMat</span>
0759 [grRules,rxnGeneMat] = standardizeGrRules(model,true);
0760 model.grRules = grRules;
0761 model.rxnGeneMat = rxnGeneMat;
0762 
0763 <span class="comment">%Remove unused fields</span>
0764 <span class="keyword">if</span> all(cellfun(@isempty,model.compOutside))
0765     model=rmfield(model,<span class="string">'compOutside'</span>);
0766 <span class="keyword">end</span>
0767 <span class="keyword">if</span> all(cellfun(@isempty,model.compMiriams))
0768     model=rmfield(model,<span class="string">'compMiriams'</span>);
0769 <span class="keyword">end</span>
0770 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnNames))
0771     model=rmfield(model,<span class="string">'rxnNames'</span>);
0772 <span class="keyword">end</span>
0773 <span class="keyword">if</span> isempty(model.rxnComps)
0774     model=rmfield(model,<span class="string">'rxnComps'</span>);
0775 <span class="keyword">end</span>
0776 <span class="keyword">if</span> all(cellfun(@isempty,model.grRules))
0777     model=rmfield(model,<span class="string">'grRules'</span>);
0778 <span class="keyword">end</span>
0779 <span class="keyword">if</span> isfield(model,<span class="string">'rxnGeneMat'</span>) &amp;&amp; isempty(model.rxnGeneMat)
0780     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
0781 <span class="keyword">end</span>
0782 <span class="keyword">if</span> all(cellfun(@isempty,model.subSystems))
0783     model=rmfield(model,<span class="string">'subSystems'</span>);
0784 <span class="keyword">end</span>
0785 <span class="keyword">if</span> all(cellfun(@isempty,model.eccodes))
0786     model=rmfield(model,<span class="string">'eccodes'</span>);
0787 <span class="keyword">end</span>
0788 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnMiriams))
0789     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
0790 <span class="keyword">end</span>
0791 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnNotes))
0792     model=rmfield(model,<span class="string">'rxnNotes'</span>);
0793 <span class="keyword">end</span>
0794 <span class="keyword">if</span> all(cellfun(@isempty,model.rxnReferences))
0795     model=rmfield(model,<span class="string">'rxnReferences'</span>);
0796 <span class="keyword">end</span>
0797 <span class="keyword">if</span> isempty(model.rxnConfidenceScores)
0798     model=rmfield(model,<span class="string">'rxnConfidenceScores'</span>);
0799 <span class="keyword">end</span>
0800 <span class="keyword">if</span> isempty(model.genes)
0801     model=rmfield(model,<span class="string">'genes'</span>);
0802 <span class="keyword">end</span>
0803 <span class="keyword">if</span> isempty(model.geneComps)
0804     model=rmfield(model,<span class="string">'geneComps'</span>);
0805 <span class="keyword">end</span>
0806 <span class="keyword">if</span> isempty(model.geneMiriams)
0807     model=rmfield(model,<span class="string">'geneMiriams'</span>);
0808 <span class="keyword">end</span>
0809 <span class="keyword">if</span> all(cellfun(@isempty,model.geneShortNames))
0810     model=rmfield(model,<span class="string">'geneShortNames'</span>);
0811 <span class="keyword">end</span>
0812 <span class="keyword">if</span> all(cellfun(@isempty,model.inchis))
0813     model=rmfield(model,<span class="string">'inchis'</span>);
0814 <span class="keyword">end</span>
0815 <span class="keyword">if</span> all(cellfun(@isempty,model.metFormulas))
0816     model=rmfield(model,<span class="string">'metFormulas'</span>);
0817 <span class="keyword">end</span>
0818 <span class="keyword">if</span> all(cellfun(@isempty,model.metMiriams))
0819     model=rmfield(model,<span class="string">'metMiriams'</span>);
0820 <span class="keyword">end</span>
0821 <span class="keyword">if</span> isempty(model.metCharges)
0822     model=rmfield(model,<span class="string">'metCharges'</span>);
0823 <span class="keyword">end</span>
0824 
0825 <span class="comment">%The model structure has now been reconstructed but it can still contain</span>
0826 <span class="comment">%many types of errors. The checkModelConsistency function is used to make</span>
0827 <span class="comment">%sure that naming and mapping of stuff looks good</span>
0828 checkModelStruct(model,~ignoreErrors);
0829 
0830 <span class="keyword">if</span> removeExcMets==true
0831     model=simplifyModel(model);
0832 <span class="keyword">end</span>
0833 <span class="keyword">end</span>
0834 
0835 <a name="_sub1" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(strings,miriamStruct)</a>
0836 <span class="comment">%Gets the names and values of Miriam-string. Nothing fancy at all, just to</span>
0837 <span class="comment">%prevent using the same code for metabolites, genes, and reactions. The</span>
0838 <span class="comment">%function also allows for supplying a miriamStruct and the info will then</span>
0839 <span class="comment">%be added</span>
0840 
0841 <span class="keyword">if</span> nargin&lt;2
0842     miriamStruct=cell(numel(strings),1);
0843 <span class="keyword">end</span>
0844 <span class="keyword">for</span> i=1:numel(strings)
0845     <span class="keyword">if</span> any(strings{i})
0846         <span class="comment">%A Miriam string can be several ids separated by &quot;;&quot;. Each id is</span>
0847         <span class="comment">%&quot;name(..:..)/value&quot;; an old format when value is separated by</span>
0848         <span class="comment">%colon is also supported</span>
0849         I=regexp(strings{i},<span class="string">';'</span>,<span class="string">'split'</span>);
0850         <span class="keyword">if</span> isfield(miriamStruct{i},<span class="string">'name'</span>)
0851             startIndex=numel(miriamStruct{i}.name);
0852             miriamStruct{i}.name=[miriamStruct{i}.name;cell(numel(I),1)];
0853             miriamStruct{i}.value=[miriamStruct{i}.value;cell(numel(I),1)];
0854         <span class="keyword">else</span>
0855             startIndex=0;
0856             miriamStruct{i}.name=cell(numel(I),1);
0857             miriamStruct{i}.value=cell(numel(I),1);
0858         <span class="keyword">end</span>
0859         
0860         <span class="keyword">for</span> j=1:numel(I)
0861             <span class="keyword">if</span> any(strfind(I{j},<span class="string">'/'</span>))
0862                 index=max(strfind(I{j},<span class="string">'/'</span>));
0863             <span class="keyword">elseif</span> any(strfind(I{j},<span class="string">':'</span>))
0864                 index=max(strfind(I{j},<span class="string">':'</span>));
0865             <span class="keyword">end</span>
0866             <span class="keyword">if</span> any(index)
0867                 miriamStruct{i}.name{startIndex+j}=I{j}(1:index-1);
0868                 miriamStruct{i}.value{startIndex+j}=I{j}(index+1:end);
0869             <span class="keyword">else</span>
0870                 EM=[<span class="string">'&quot;'</span> I{j} <span class="string">'&quot; is not a valid MIRIAM string. The format must be &quot;identifier/value&quot; or identifier:value'</span>];
0871                 dispEM(EM);
0872             <span class="keyword">end</span>
0873         <span class="keyword">end</span>
0874     <span class="keyword">end</span>
0875 <span class="keyword">end</span>
0876 <span class="keyword">end</span>
0877 
0878 <span class="comment">%For converting a value to string. This is used instead of num2str because</span>
0879 <span class="comment">%I want to convert empty cells to {''}.</span>
0880 <a name="_sub2" href="#_subfunctions" class="code">function y=toStr(x)</a>
0881 <span class="comment">%x can be empty, numerical, string or boolean. It cannot be NaN. Boolean</span>
0882 <span class="comment">%values will be converted to '1'/'0'</span>
0883 <span class="keyword">if</span> isempty(x)
0884     y=<span class="string">''</span>;
0885 <span class="keyword">else</span>
0886     y=num2str(x);
0887 <span class="keyword">end</span>
0888 <span class="keyword">end</span>
0889 
0890 <span class="comment">%For converting to numeric. This is used instead of str2num because I want</span>
0891 <span class="comment">%to be able to choose what empty values should be mapped to.</span>
0892 <span class="comment">%</span>
0893 <span class="comment">% default the value to use for empty input</span>
0894 <a name="_sub3" href="#_subfunctions" class="code">function y=toDouble(x,default)</a>
0895 <span class="keyword">if</span> isempty(x) <span class="comment">%Note that this catches '' as well</span>
0896     y=default;
0897 <span class="keyword">else</span>
0898     <span class="keyword">if</span> isnumeric(x)
0899         y=x;
0900     <span class="keyword">else</span>
0901         y=str2double(x);
0902         
0903         <span class="comment">%This happens if the input couldn't be converted. Note that the</span>
0904         <span class="comment">%input itself cannot be NaN since it was fixed in clean imported</span>
0905         <span class="keyword">if</span> isnan(y)
0906             EM=[<span class="string">'Cannot convert the string &quot;'</span> x <span class="string">'&quot; to double'</span>];
0907             dispEM(EM);
0908         <span class="keyword">end</span>
0909     <span class="keyword">end</span>
0910 <span class="keyword">end</span>
0911 <span class="keyword">end</span>
0912 
0913 <span class="comment">%For converting boolean (the UNCONSTRAINED field) to double (the</span>
0914 <span class="comment">%model.unconstrained field)</span>
0915 <a name="_sub4" href="#_subfunctions" class="code">function y=boolToDouble(x)</a>
0916 <span class="keyword">if</span> isempty(x)
0917     y=0;
0918     <span class="keyword">return</span>;
0919 <span class="keyword">end</span>
0920 <span class="keyword">if</span> islogical(x)
0921     y=x*1; <span class="comment">%Typecast to double</span>
0922     <span class="keyword">return</span>;
0923 <span class="keyword">end</span>
0924 <span class="keyword">if</span> isnumeric(x)
0925     <span class="keyword">if</span> x~=0
0926         y=1;
0927         <span class="keyword">return</span>;
0928     <span class="keyword">else</span>
0929         y=0;
0930         <span class="keyword">return</span>;
0931     <span class="keyword">end</span>
0932 <span class="keyword">end</span>
0933 <span class="keyword">if</span> ischar(x)
0934     <span class="keyword">if</span> strcmpi(x,<span class="string">'TRUE'</span>)
0935         y=1;
0936         <span class="keyword">return</span>;
0937     <span class="keyword">end</span>
0938     <span class="keyword">if</span> strcmpi(x,<span class="string">'FALSE'</span>)
0939         y=0;
0940         <span class="keyword">return</span>;
0941     <span class="keyword">end</span>
0942 <span class="keyword">end</span>
0943 y=NaN; <span class="comment">%This means that the input couldn't be parsed</span>
0944 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 22-Aug-2018 16:19:49 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>